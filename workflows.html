<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workflows &mdash; Image Portal Workflows  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API" href="api.html" />
    <link rel="prev" title="Development" href="development.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Image Portal Workflows
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="development.html">Development</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Workflows</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#inputs-outputs">Inputs/Outputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#working-directory-temporary-dir">Working directory / temporary dir.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#processes">Processes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#generate-brt-directive-file">Generate BRT Directive File</a></li>
<li class="toctree-l3"><a class="reference internal" href="#batchruntomo-brt">BatchRunTomo (BRT)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generate-tilt-movie">Generate tilt movie</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generate-reconstruction-movie">Generate reconstruction movie</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generate-neuroglancer-pyramid">Generate Neuroglancer Pyramid</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="hpc.html">RML HPC (Big Sky)</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Image Portal Workflows</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Workflows</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/workflows.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="workflows">
<h1>Workflows<a class="headerlink" href="#workflows" title="Permalink to this heading"></a></h1>
<p>Overview:</p>
<p>A number of parameters can be passed to the “BRT” workflow. There are two types:
1) params that are passed to the adoc file. See adoc / <a class="reference external" href="https://bio3d.colorado.edu/imod/doc/directives.html">https://bio3d.colorado.edu/imod/doc/directives.html</a>
2) params that are used elsewhere within the worflow, providing metadata etc, eg input_dir.</p>
<section id="inputs-outputs">
<h2>Inputs/Outputs<a class="headerlink" href="#inputs-outputs" title="Permalink to this heading"></a></h2>
<p>Within HPC, each environment (dev,qa,prod) has its own mount point. These are:
/mnt/ai-fas12/RMLEMHedwigDev/
/mnt/ai-fas12/RMLEMHedwigQA/
/mnt/ai-fas12/RMLEMHedwigProd/</p>
<p>There are inputs and outputs. We never write to the inputs directory, only to outputs.
The output dir is defined as input directory with s/Projects/Projects/. For example:</p>
<p>This would be a dev input directory, note the Projects substr.
Inputs are provided via the parameter input_dir.
/mnt/ai-fas12/RMLEMHedwigDev/Projects/RTB/darrellh/nguyenm8-2022-0920-test/SEM-2022-0922-Neta_2D_Test/DM4_sample/
And this would be the corresponding output directory.
/mnt/ai-fas12/RMLEMHedwigDev/Assets/RTB/darrellh/nguyenm8-2022-0920-test/SEM-2022-0922-Neta_2D_Test/DM4_sample/</p>
<p>For the above example, the workflow input_dir would be provided as:
/RTB/darrellh/nguyenm8-2022-0920-test/SEM-2022-0922-Neta_2D_Test/DM4_sample/</p>
<p>Note, the partition is not mentioned, and by implication we know this is a Project.
So to create the input dir, we prepend the &lt;name_of_partition&gt;/Projects/&lt;input_dir_param&gt;
The above logic is done in utils.get_input_dir()</p>
<p>To find out what we are expected to work on we list this directory, see utils.list_files. Note, FIBSEM uses dirs to define stacks. We filter inputs with file extensions.</p>
<p>The input directory is listed, and a temp working directory is created for each input (a file for the 2D and BRT pipelines, or a directory containing a stack of tiffs for FIBSEM).</p>
</section>
<section id="working-directory-temporary-dir">
<h2>Working directory / temporary dir.<a class="headerlink" href="#working-directory-temporary-dir" title="Permalink to this heading"></a></h2>
<p>For each input (eg file), I create one temporary directory. All work occurs in this directory. Upon the conclusion of the workflow, the contents of this directory are copied into the Assets directory (see Inputs/Outputs.
A list of Objects of class FilePath are used to these inputs.</p>
<p>Note: objects passed between Prefect Tasks (eg FilePath objects), must be considered immutable. Updates to state made in one task will be lost and not available to the next task. Create a new object.
The map function is used extensively, and preserves order.</p>
<p>TomoJS 3D pipeline for tomographic reconstruction.</p>
<p>The term “batch run tomo[gram]” is abbreviated BRT.</p>
</section>
<section id="processes">
<h2>Processes<a class="headerlink" href="#processes" title="Permalink to this heading"></a></h2>
<section id="generate-brt-directive-file">
<h3>Generate BRT Directive File<a class="headerlink" href="#generate-brt-directive-file" title="Permalink to this heading"></a></h3>
<dl class="simple">
<dt>Description:</dt><dd><p>Generate a configuration file of parameter for BRT process.</p>
</dd>
<dt>Outputs:</dt><dd><ul class="simple">
<li><p>a BRT directive file with a <cite>.adoc</cite> file extension.</p></li>
</ul>
</dd>
</dl>
<p>Alternatively, the file could be provided and this step skipped. The directive file format is documented IMOD’s
<a class="reference external" href="https://bio3d.colorado.edu/imod/doc/man/batchruntomo.html">batchruntomo</a> documentation. There is specific descriptions of the <a class="reference external" href="https://bio3d.colorado.edu/imod/doc/directives.html">directives</a> specified in a “directives.csv”
file within IMOD.</p>
<p>The following is a Jinja like template for key-value pairs to be configured. The <cite>{{ }}</cite> denotes where the substitution
should be made. Inside the curly brackets is a suggested parameter name for the value with defaults in parenthesis:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">setupset</span><span class="o">.</span><span class="n">copyarg</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="p">{{</span> <span class="n">basename</span> <span class="p">}}</span>
<span class="n">setupset</span><span class="o">.</span><span class="n">copyarg</span><span class="o">.</span><span class="n">gold</span><span class="o">=</span><span class="p">{{</span> <span class="n">beadSize</span> <span class="p">(</span><span class="o">~</span><span class="mi">10</span><span class="p">)}}</span>
<span class="n">setupset</span><span class="o">.</span><span class="n">copyarg</span><span class="o">.</span><span class="n">pixel</span><span class="o">=</span><span class="p">{{</span> <span class="n">pixelSize</span> <span class="p">}}</span>
<span class="n">comparam</span><span class="o">.</span><span class="n">prenewst</span><span class="o">.</span><span class="n">newstack</span><span class="o">.</span><span class="n">BinByFactor</span><span class="o">=</span><span class="p">{{</span> <span class="nb">bin</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">}}</span>
<span class="n">comparam</span><span class="o">.</span><span class="n">track</span><span class="o">.</span><span class="n">beadtrack</span><span class="o">.</span><span class="n">LightBeads</span><span class="o">=</span><span class="p">{{</span> <span class="n">lightBeads</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">}}</span>
<span class="n">comparam</span><span class="o">.</span><span class="n">tilt</span><span class="o">.</span><span class="n">tilt</span><span class="o">.</span><span class="n">THICKNESS</span><span class="o">=</span><span class="p">{{</span> <span class="n">thickness</span> <span class="p">(</span><span class="o">~</span><span class="mi">256</span><span class="p">)</span> <span class="p">}}</span>
<span class="n">runtime</span><span class="o">.</span><span class="n">AlignedStack</span><span class="o">.</span><span class="n">any</span><span class="o">.</span><span class="n">binByFactor</span><span class="o">=</span><span class="p">{{</span> <span class="nb">bin</span> <span class="p">}}</span>
<span class="n">setupset</span><span class="o">.</span><span class="n">copyarg</span><span class="o">.</span><span class="n">montage</span><span class="o">=</span><span class="p">{{</span> <span class="n">montage</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">}}</span>
<span class="n">setupset</span><span class="o">.</span><span class="n">datasetDirectory</span><span class="o">=</span><span class="p">{{</span> <span class="n">local</span> <span class="n">processing</span> <span class="n">folder</span> <span class="p">(</span><span class="n">POSIX</span> <span class="n">convention</span><span class="p">)</span> <span class="p">}}</span>
</pre></div>
</div>
<p>The existing directive file is <cite>dirTemplate.adoc</cite> with empty values that can be updated as above.</p>
<p>BRT support multiple layers of “Template Files”  so that directives can be defined for a microscope, system, and user.
The other directive files can be defined as parameters it the batch directive file provided on the command line.</p>
</section>
<section id="batchruntomo-brt">
<h3>BatchRunTomo (BRT)<a class="headerlink" href="#batchruntomo-brt" title="Permalink to this heading"></a></h3>
<dl class="simple">
<dt>Description:</dt><dd><p>Perform computational expensive operations of processing an acquired tomography tilt-series and reconstructing a 3D
volume. The process consists of numerous step to prepare, align, and perform 3d reconstruction from the tilt series
acquired by the microscope.</p>
</dd>
<dt>Inputs:</dt><dd><ol class="arabic simple">
<li><p>the original image from the microscope usually with an <cite>.mrc</cite> extension (<cite>.st</cite> possible ). The filename part before
the final “.” is considered the <cite>BASENAME</cite>.</p></li>
<li><p>BRT directive file</p></li>
</ol>
</dd>
<dt>Primary Outputs:</dt><dd><ol class="arabic simple">
<li><p><cite>BASENAME_rec.mrc</cite> - the source for the reconstruction movie</p></li>
<li><p><cite>BASENAME_full_rec.mrc</cite> - the source for the Neuroglancer pyramid</p></li>
<li><p><cite>BASENAME_ali.mrc</cite> - the source for the tilt movie</p></li>
</ol>
</dd>
<dt>Auxiliary Outputs:</dt><dd><ol class="arabic simple">
<li><p>Other outputs such as logs and transformation files may need to be saved as well.</p></li>
</ol>
</dd>
</dl>
<p>The process is IMOD’s <a class="reference external" href="https://bio3d.colorado.edu/imod/doc/man/batchruntomo.html">batchruntomo</a>, run with the following command line arguments:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">batchruntomo</span> <span class="o">-</span><span class="n">di</span> <span class="n">BASENAME</span><span class="o">.</span><span class="n">adoc</span> <span class="o">-</span><span class="n">gpus</span> <span class="mi">1</span> <span class="o">-</span><span class="n">cpus</span> <span class="mi">20</span>
</pre></div>
</div>
<p>The <cite>gpus</cite> is for configuring the local GPU, and <cite>cpus</cite> configures the number of cores to use.  Many
temporary and log files are created during this process.</p>
</section>
<section id="generate-tilt-movie">
<h3>Generate tilt movie<a class="headerlink" href="#generate-tilt-movie" title="Permalink to this heading"></a></h3>
<dl class="simple">
<dt>Description:</dt><dd><p>Convert a MRC file of the aligned tilt series into a movie for easy viewing.</p>
</dd>
<dt>Inputs:</dt><dd><ol class="arabic simple">
<li><p><cite>BASENAME_ali.mrc</cite> - the aligned 2d slices of image stack</p></li>
</ol>
</dd>
<dt>Outputs:</dt><dd><ol class="arabic simple">
<li><p>Generates a tilt movie for easy viewing</p></li>
<li><p>The key thumbnail is  keyimg_BASENAME_s.jpg, the corresponding MIDDLE_I is the full size.</p></li>
</ol>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>dimensions = (header -s ${BASENAME}_ali.mrv) # space separated list of dimensions sizes (x y z)
MIDDLE_I = floor(dimensions.z/2))
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for i in dimensions.z\:
  newstack -secs {i}-{i} ALI_FILENAME WORKDIR/hedwig/BASENAME_ali{i}.mrc
newstack -float 3 WORKDIR/hedwig/BASENAME_ali*.mrc WORKDIR/hedwig/ali_BASENAME.mrc
mrc2tif -j -C 0,255 WORKDIR/hedwig/ali_BASENAME.mrc WORKDIR/hedwig/BASENAME_ali
gm convert -size 300x300 WORKDIR/hedwig/BASENAME_ali.{MIDDLE_I}.jpg -resize 300x300 -sharpen 2 -quality 70 WORKDIR/hedwig/keyimg_BASENAME_s.jpg
ffmpeg -f image2 -framerate 4 -i ${BASENAME}_ali.%03d.jpg -vcodec libx264 -pix_fmt yuv420p -s 1024,1024 tiltMov_${BASENAME}.mp4
</pre></div>
</div>
</section>
<section id="generate-reconstruction-movie">
<h3>Generate reconstruction movie<a class="headerlink" href="#generate-reconstruction-movie" title="Permalink to this heading"></a></h3>
<dl class="simple">
<dt>Description:</dt><dd><p>Convert a MRC file of the reconstructed 3D volume into a movie for easy viewing.</p>
</dd>
<dt>Inputs:</dt><dd><ol class="arabic simple">
<li><p><cite>BASENAME_rec.mrc</cite> - the reconstruction of the 3d volume ( may already be binned by some factor when compared to full).</p></li>
</ol>
</dd>
<dt>Outputs:</dt><dd><ol class="arabic simple" start="2">
<li><p>Generates a movie of the reconstructed 3D volume.</p></li>
</ol>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for i in range(2, dimensions.z-2):
  IZMIN = i-2
  IZMAX = i+2
  clip avg -2d -iz IZMIN-IZMAX  -m 1 WORKDIR/BASENAME_rec.mrc WORKDIR/hedwig/BASENAME_ave${I}.mrc
newstack -float 3 WORKDIR/hedwig/BASENAME_ave* WORKDIR/hedwig/ave_BASENAME.mrc
binvol -binning 2 WORKDIR/hedwig/ave_BASENAME.mrc WORKDIR/hedwig/avebin8_BASENAME.mrc
mrc2tif -j -C 100,255 WORKDIR/hedwig/ave_BASNAME.mrc hedwig/BASENAME_mp4
ffmpeg -f image2 -framerate 8 -i WORKDIR/hedwig/BASENAME_mp4.%04d.jpg -vcodec libx264 -pix_fmt yuv420p -s 1024,1024 WORKDIR/hedwig/keyMov_BASENAME.mp4
</pre></div>
</div>
</section>
<section id="generate-neuroglancer-pyramid">
<h3>Generate Neuroglancer Pyramid<a class="headerlink" href="#generate-neuroglancer-pyramid" title="Permalink to this heading"></a></h3>
<dl>
<dt>Descriptions:</dt><dd><p>Generates a <a class="reference external" href="https://github.com/google/neuroglancer">Neuroglancer</a> <a class="reference external" href="https://github.com/google/neuroglancer/blob/master/src/neuroglancer/datasource/precomputed/volume.md">precomputed</a> pyramid from an MRC file of a 3D volume. This does not work for tilt series, or other
non-volumetric files.</p>
</dd>
<dt>Inputs:</dt><dd><ol class="arabic simple">
<li><p>A MRC file of a 3D volume.</p></li>
</ol>
</dd>
<dt>Outputs:</dt><dd><ol class="arabic simple">
<li><p>A directory structure of the <a class="reference external" href="https://github.com/google/neuroglancer/blob/master/src/neuroglancer/datasource/precomputed/volume.md">precomputed</a> pyramid.</p></li>
</ol>
</dd>
<dt>Steps:</dt><dd><p>1. Convert the MRC file to NIFTI (<cite>.nii</cite>).
The Neuroglancer file format only support unsigned integer of 8 or 16 bits. When this input is a signed integer the
output pixel types needs to be changed and the pixel values adjusted. The NIAID <a class="reference external" href="https://github.com/niaid/tomojs-pytools">tomojs-pytools</a> <cite>mrc2nift</cite>
command-line tool can do this conversion.
2. The <a class="reference external" href="https://github.com/HumanBrainProject/neuroglancer-scripts">neuroglancer-scripts</a> tools are used to convert the NIFTI file to the precompute format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">volume</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">precomputed</span><span class="o">-</span><span class="n">pyramid</span> <span class="o">--</span><span class="n">downscaling</span><span class="o">-</span><span class="n">method</span><span class="o">=</span><span class="n">average</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">gzip</span> <span class="o">--</span><span class="n">flat</span> <span class="n">nifti</span><span class="o">.</span><span class="n">nii</span> <span class="p">{</span><span class="n">WORKDIR</span><span class="p">}</span><span class="o">/</span><span class="n">hedwig</span><span class="o">/</span><span class="n">neuro</span><span class="o">-</span><span class="n">BASENAME</span>
</pre></div>
</div>
<p>3. The default minimum and maximum values used for visualization also need to be computed from the NIFTI file. The
NIAID <a class="reference external" href="https://github.com/niaid/tomojs-pytools">tomojs-pytools</a> <cite>mrc_visual_min_max</cite> performs this computation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mrc_visual_min_max</span> <span class="p">{</span><span class="n">WORKDIR</span><span class="p">}</span><span class="o">/</span><span class="n">nifti</span><span class="o">.</span><span class="n">nii</span> <span class="o">--</span><span class="n">mad</span> <span class="mi">5</span> <span class="o">--</span><span class="n">output</span><span class="o">-</span><span class="n">json</span> <span class="n">mrc2ngpc</span><span class="o">-</span><span class="n">output</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
</dd>
</dl>
<p>The <a class="reference external" href="https://github.com/seung-lab/cloud-volume">cloud-volume</a> tool may be an alternative tool for the precompute conversion.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="development.html" class="btn btn-neutral float-left" title="Development" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="api.html" class="btn btn-neutral float-right" title="API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, NIAID.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>