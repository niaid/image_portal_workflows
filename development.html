<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Development &mdash; Image Portal Workflows  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Workflows" href="workflows.html" />
    <link rel="prev" title="Image Portal Workflows’s documentation" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Image Portal Workflows
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Development</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#github-com">Github.com</a></li>
<li class="toctree-l3"><a class="reference internal" href="#local-set-up">Local Set-up</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hpc-set-up">HPC Set up</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#note-this-is-only-relevant-for-hpc-added-for-completeness">NOTE, THIS IS <strong>ONLY</strong> relevant for HPC. Added for completeness.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#updating-venvs">Updating venvs:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#prefect-agent">Prefect Agent:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#register-workflows">Register Workflows:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#git-lfs">Git LFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#flake8">Flake8</a></li>
<li class="toctree-l3"><a class="reference internal" href="#black">Black</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#pull-requests">Pull Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#testing">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sphinx-documentation">Sphinx Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="hpc.html">RML HPC (Big Sky)</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Image Portal Workflows</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Development</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/development.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="development">
<h1>Development<a class="headerlink" href="#development" title="Permalink to this heading"></a></h1>
<p>The docs related to development and testing are contained in this section.</p>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this heading"></a></h2>
<p>Please read this Development section before cloning. The <cite>generate_venv.sh</cite> script referenced below
automates much of the process. Current system assumes that you are locally running either a Linux
or Mac OS.</p>
<section id="github-com">
<h3>Github.com<a class="headerlink" href="#github-com" title="Permalink to this heading"></a></h3>
<p>The repository is located in the NIAID Github.com enterprise organization. Having a github.com account
which is a member of the NIAID organization is required.</p>
</section>
<section id="local-set-up">
<h3>Local Set-up<a class="headerlink" href="#local-set-up" title="Permalink to this heading"></a></h3>
<p>You will need a minimal Python installation to run the <cite>generate_venv.sh</cite> script.
The following programs need to be available locally:</p>
<ul class="simple">
<li><p>Java runtime (in order to run <cite>etomo</cite> in BRT)</p></li>
<li><p>ffmpeg (in order to create movies)</p></li>
</ul>
<p>Similar to the HPC Set up below, you can locally set up <cite>dev</cite> and <cite>qa</cite> virtual envs.</p>
<p>Special note for <strong>Mac M1</strong>: The <cite>tomojs-pytools</cite> library depends on imagecodecs which does
not have binaries built for the M1. Need to install using an x86_64 version of Python.</p>
</section>
<section id="hpc-set-up">
<h3>HPC Set up<a class="headerlink" href="#hpc-set-up" title="Permalink to this heading"></a></h3>
<section id="note-this-is-only-relevant-for-hpc-added-for-completeness">
<h4>NOTE, THIS IS <strong>ONLY</strong> relevant for HPC. Added for completeness.<a class="headerlink" href="#note-this-is-only-relevant-for-hpc-added-for-completeness" title="Permalink to this heading"></a></h4>
<p>Workflows are currently run on RML HPC (“BigSky”).</p>
<p>There are three environments currently on BigSky: (<cite>dev</cite>, <cite>qa</cite>, <cite>prod</cite>).
They were set up as follows:
(Note, this first step is only required once, and only to work around ancient versions of Python.)</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Obtain and set up Miniconda (to allow setting up of venvs) e.g.</span>
wget<span class="w"> </span>https://repo.anaconda.com/miniconda/Miniconda3-py39_4.11.0-Linux-x86_64.sh
<span class="c1"># Activate conda to create the virtual environment</span>
conda<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>conda_env
conda<span class="w"> </span>activate<span class="w"> </span>conda_env
<span class="c1"># create venv, &quot;some_name&quot; for example</span>
python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>some_name
<span class="c1"># don&#39;t need the conda env any more...</span>
conda<span class="w"> </span>deactivate
</pre></div>
</div>
<p>A script exists to help set up <cite>dev</cite>, <cite>qa</cite>, or <cite>prod</cite> environments in
<cite>$HOME/code/hedwig/&lt;HEDWIG_ENV&gt;</cite>
Insure <cite>$HOME/code/hedwig</cite> exists. Runs on Linux.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:niaid/image_portal_workflows.git
<span class="c1"># generates venv qa.</span>
./image_portal_workflows/helper_scripts/generate_venv.sh<span class="w"> </span>qa
</pre></div>
</div>
</section>
<section id="updating-venvs">
<h4>Updating venvs:<a class="headerlink" href="#updating-venvs" title="Permalink to this heading"></a></h4>
<p>To update your python virtual environment:
Change into the correct venv directory, e.g. <cite>~/code/hedwig/dev/image_portal_workflows</cite>.
Ensure environment is active and run something like:</p>
<p><cite>pip   install -e . -r requirements.txt –upgrade  –find-links https://github.com/niaid/tomojs-pytools/releases/tag/v1.3</cite></p>
</section>
<section id="prefect-agent">
<h4>Prefect Agent:<a class="headerlink" href="#prefect-agent" title="Permalink to this heading"></a></h4>
<p>The prefect agent, the thing that reaches out to the prefect API machine, is daemonized on HPC.
See <cite>image_portal_workflows/helper_scripts/hedwig_reg_listen.sh</cite> and
<cite>image_portal_workflows/helper_scripts/hedwig_listener_prod.service</cite> etc.</p>
</section>
<section id="register-workflows">
<h4>Register Workflows:<a class="headerlink" href="#register-workflows" title="Permalink to this heading"></a></h4>
<p>To register a new workflow, or update an existing one (in <cite>qa</cite> environment):
(The workflow needs to be registered every time the source is updated.)
<cite>image_portal_workflows/helper_scripts/hedwig_reg_listen.sh qa register</cite></p>
<p>Currently dask jobqueue is configured with a yaml file.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>~/.config/dask/jobqueue.yaml
<span class="c1"># Dask worker options</span>
cores:<span class="w"> </span><span class="m">8</span><span class="w">                </span><span class="c1"># Total number of cores per job</span>
memory:<span class="w"> </span><span class="s2">&quot;64 GB&quot;</span><span class="w">                </span><span class="c1"># Total amount of memory per job</span>
processes:<span class="w"> </span><span class="m">1</span><span class="w">                </span><span class="c1"># Number of Python processes per job</span>

<span class="c1"># interface: ens160           # Network interface to use like eth0 or ib0</span>
death-timeout:<span class="w"> </span><span class="m">120</span><span class="w">           </span><span class="c1"># Number of seconds to wait if a worker can not find a scheduler</span>
local-directory:<span class="w"> </span>/gs1/home/macmenaminpe/tmp<span class="w">       </span><span class="c1"># Location of fast local storage like /scratch or $TMPDIR</span>
job_extra_directives:<span class="w"> </span><span class="o">[</span><span class="s2">&quot;--gres=gpu:1&quot;</span><span class="o">]</span>

<span class="c1"># SLURM resource manager options</span>
shebang:<span class="w"> </span><span class="s2">&quot;#!/usr/bin/env bash&quot;</span>
queue:<span class="w"> </span>gpu
project:<span class="w"> </span>null
walltime:<span class="w"> </span><span class="s1">&#39;10:00:00&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Note, although unused above, BigSky also has Spack available.</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">source</span><span class="w"> </span>/gs1/apps/user/rmlspack/share/spack/setup-env.sh
$<span class="w"> </span>spack<span class="w"> </span>load<span class="w"> </span>-r<span class="w"> </span>python@3.8.6/eg2vaag
$<span class="w"> </span>python<span class="w"> </span>-V
Python<span class="w"> </span><span class="m">3</span>.8.6
$<span class="w"> </span>spack<span class="w"> </span>unload<span class="w"> </span>-a
</pre></div>
</div>
</section>
</section>
<section id="git-lfs">
<h3>Git LFS<a class="headerlink" href="#git-lfs" title="Permalink to this heading"></a></h3>
<p><strong>UPDATE 10-Mar-2023: LFS isn’t currently being used due to cost considerations.</strong></p>
<p>Git <a class="reference external" href="https://git-lfs.github.com">Large File Storage</a> (LFS) is used to store larger files in the repository such as
test images, trained models, and other data ( i.e. not text based code ). Before the repository is cloned, git lfs must
be installed on the system and set up on the users account. The <a class="reference external" href="https://git-lfs.github.com">tool’s documentation</a>
provides details on installation, set up, and usage that is not duplicated here. Once set up the git usage is usually
transparent with operation such as cloning, adding files, and changing branches.</p>
<p>The “.gitattributes” configuration file automatically places files in the directories “test/data” and “cxr_similarity/data” to
be stored in Git LFS.</p>
</section>
<section id="flake8">
<h3>Flake8<a class="headerlink" href="#flake8" title="Permalink to this heading"></a></h3>
<p><a class="reference external" href="https://pypi.org/project/flake8/">Flake8</a> is a CLI utility used to enforce style and do linting.</p>
</section>
<section id="black">
<h3>Black<a class="headerlink" href="#black" title="Permalink to this heading"></a></h3>
<p><a class="reference external" href="https://pypi.org/project/black/">Black</a> is a CLI utility that enforces a standard formatting on Python which helps with code consistancy.</p>
</section>
</section>
<section id="pull-requests">
<h2>Pull Requests<a class="headerlink" href="#pull-requests" title="Permalink to this heading"></a></h2>
<p>To contribute to the project first ensure your fork is in good shape, and then the generate a Pull Request (PR) to the <cite>niaid</cite> fork. Below is an outline an of the kind of steps that could be followed. More thorough documentation can be found here: <a class="reference external" href="https://docs.github.com/en/github/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request">https://docs.github.com/en/github/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request</a></p>
<ul>
<li><p>Fork niaid repo into your gh account using the web interface.</p></li>
<li><p>Clone your repo to local machine, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">git</span><span class="nd">@github</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="n">philipmac</span><span class="o">/</span><span class="n">nih_3d_workflows</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
</li>
<li><p>Set <cite>upstream</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">remote</span> <span class="n">add</span> <span class="n">upstream</span> <span class="n">git</span><span class="nd">@github</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="n">niaid</span><span class="o">/</span><span class="n">nih_3d_workflows</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
</li>
<li><p>ensure origin and upstream look something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git remote -v
origin        git@github.com:your_uname/image_portal_workflows.git (fetch)
origin        git@github.com:your_uname/image_portal_workflows.git (push)
upstream      git@github.com:niaid/image_portal_workflows.git (fetch)
upstream      git@github.com:niaid/image_portal_workflows.git (push)
</pre></div>
</div>
</li>
<li><p>Make edits to local copy.</p></li>
<li><p>Run <cite>flake8</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flake8</span> <span class="o">.</span> <span class="o">--</span><span class="nb">max</span><span class="o">-</span><span class="n">line</span><span class="o">-</span><span class="n">length</span><span class="o">=</span><span class="mi">127</span>
</pre></div>
</div>
</li>
<li><p>Run <cite>Black</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">black</span> <span class="o">.</span>
</pre></div>
</div>
</li>
<li><p>Ensure neither <cite>black</cite> nor <cite>flake8</cite> are complaining.</p></li>
<li><p>Commit your local work, ensure you’re up to date with <cite>upstream</cite>, and push to <cite>origin</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">m</span> <span class="s2">&quot;Fixes issue 123, ...&quot;</span>
<span class="n">git</span> <span class="n">fetch</span> <span class="n">upstream</span>
<span class="n">git</span> <span class="n">rebase</span> <span class="n">upstream</span><span class="o">/</span><span class="n">master</span>
<span class="n">git</span> <span class="n">push</span> <span class="n">origin</span> <span class="n">branch_with_fix</span>
</pre></div>
</div>
</li>
<li><p>Initiate creation the Pull Request (PR) via your fork into niaid/nih-3d-main using the web interface.</p></li>
<li><p>Look at your changes, ensure <em>only</em> those changes are included in your PR.</p></li>
<li><p>Submit PR with some helpful English. See: <a class="reference external" href="https://git-scm.com/book/en/v2/Distributed-Git-Contributing-to-a-Project">https://git-scm.com/book/en/v2/Distributed-Git-Contributing-to-a-Project</a></p></li>
<li><p>Feel free to let a niaid repo admin (currently Philip MacM and Bradley Lowenkamp) know there’s a PR waiting for review.</p></li>
<li><p>Thanks! :)</p></li>
</ul>
</section>
<section id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this heading"></a></h2>
<p>There are currently four Pytest files in the <cite>test</cite> directory:</p>
<ul class="simple">
<li><p>test_dm: 2D</p></li>
<li><p>test_brt: batchruntomo</p></li>
<li><p>test_sem:</p></li>
<li><p>test_callback: I believe this test is out-of-date and needs some fixing</p></li>
</ul>
<p>There is test data for <cite>test_dm</cite> in the Git repo, but not for the other two. These files need to be
downloaded from the HPC machines. The following script will copy them:</p>
<p><cite>test/copy_test_data.sh</cite></p>
<p>These files are quite large, so you may want to run each line separately at the command line.</p>
</section>
<section id="sphinx-documentation">
<h2>Sphinx Documentation<a class="headerlink" href="#sphinx-documentation" title="Permalink to this heading"></a></h2>
<p><a class="reference external" href="https://www.sphinx-doc.org/">Sphinx</a> documentation as automatically rendered and pushed the the gh-pages branch. The
API is documented in Sphinx from the the Python docstring automatically for the public module methods and select private
methods.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Image Portal Workflows’s documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="workflows.html" class="btn btn-neutral float-right" title="Workflows" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, NIAID.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>